name: Lint Toolchain

on: [push, pull_request, workflow_dispatch]

jobs:
  lint-toolchain:
    name:    Lint Toolchain
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: MFC Python setup
      uses: actions/setup-python@v5
      with:
        python-version: '3.14'

    - name: Initialize MFC
      run: ./mfc.sh init

    - name: Lint the toolchain
      run: ./mfc.sh lint

    - name: Check generated files are up to date
      run: ./mfc.sh generate --check

    - name: CLI smoke tests
      run: |
        ./mfc.sh --help
        ./mfc.sh build --help
        ./mfc.sh run --help
        ./mfc.sh test --help
        ./mfc.sh params --count
        ./mfc.sh new --list

    - name: Parameter registry validation
      run: |
        source build/venv/bin/activate
        python3 -c "from mfc.params import REGISTRY; from mfc.run.case_dicts import ALL; n=len(REGISTRY.all_params); assert n>3000; print(f'Registry: {n} parameters'); assert set(REGISTRY.all_params.keys())==set(ALL.keys()); print('Registry matches case_dicts')"

    - name: Bash completion syntax check
      run: bash -n toolchain/completions/mfc.bash

    - name: Validate example cases
      run: |
        ./mfc.sh validate examples/1D_sodshocktube/case.py
        ./mfc.sh validate examples/2D_shockbubble/case.py
