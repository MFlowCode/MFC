name: Release Dispatcher

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      from_tag:
        description: 'Start tag (e.g. v4.3.0)'
        required: false
        default: 'v5.1.3'
      to_tag:
        description: 'End tag (e.g. v5.1.3)'
        required: false
        default: 'v5.1.3'
env:
  FROM_TAG: ${{ github.event.inputs.from_tag || 'v5.1.3' }}
  TO_TAG: ${{ github.event.inputs.to_tag || 'v5.1.3' }}

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Get tags in range
        id: tags
        run: |
          git clone --quiet https://github.com/MFlowCode/MFC.git mfc
          cd mfc
          git fetch --tags
          TAGS=$(git tag --sort=creatordate)
          TAGS_IN_RANGE=$(awk "/^${{ env.FROM_TAG }}$/,/^${{ env.TO_TAG }}$/" <<< "$TAGS" | grep -v '^$')
          echo "tags=$(echo $TAGS_IN_RANGE | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Dispatch bench.yml for each tag
        uses: actions/github-script@v7
        with:
          script: |
            const tags = '${{ steps.tags.outputs.tags }}'.split(' ').filter(Boolean);
            for (const tag of tags) {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'bench.yml',
                ref: context.ref.replace('refs/heads/', ''),
                inputs: { tag }
              });

              let runId = null;
              for (let i = 0; i < 60; i++) { // Try for up to 300 seconds
                const runs = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'bench.yml',
                  event: 'workflow_dispatch',
                  per_page: 5
                });
                // Find the most recent queued or in_progress run
                const found = runs.data.workflow_runs.find(run =>
                  ['queued', 'in_progress'].includes(run.status)
                );
                if (found) {
                  runId = found.id;
                  break;
                }
                await new Promise(resolve => setTimeout(resolve, 5000));
              }
              if (!runId) {
                core.setFailed(`Could not find workflow run for tag ${tag}`);
                return;
              }

              let completed = false;
              while (!completed) {
                const run = await github.rest.actions.getWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: runId
                });
                if (run.data.status === 'completed') {
                  if (run.data.conclusion !== 'success') {
                    core.setFailed(`Workflow for tag ${tag} failed with conclusion: ${run.data.conclusion}`);
                    return;
                  }
                  completed = true;
                } else {
                  await new Promise(resolve => setTimeout(resolve, 15000));
                }
              }
            }
