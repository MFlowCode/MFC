#compdef mfc.sh ./mfc.sh mfc
# Zsh completion for MFC (mfc.sh)
#
# To enable, add this directory to your fpath and run compinit:
#   fpath=(/path/to/MFC/toolchain/completions $fpath)
#   autoload -Uz compinit && compinit
# Or copy this file to a directory already in your fpath (e.g., ~/.zsh/completions/)

_mfc() {
    local context state state_descr line
    typeset -A opt_args

    local commands=(
        'build:Build MFC and its dependencies'
        'run:Run a simulation case'
        'test:Run the MFC test suite'
        'clean:Remove build artifacts'
        'validate:Check a case file for errors'
        'init:Create a new case from a template'
        'count:Count lines of code'
        'packer:Pack/unpack/compare simulation data'
        'load:Load MFC environment (use with source)'
        'lint:Lint code after editing'
        'format:Format code after editing'
        'spelling:Run spell checker'
        'interactive:Launch interactive menu'
        'completion:Install shell tab-completion'
    )

    local targets=(
        'pre_process:Pre-processing target'
        'simulation:Main simulation target'
        'post_process:Post-processing target'
    )

    local templates=(
        '1D_minimal:Minimal 1D shock tube case'
        '2D_minimal:Minimal 2D case with circular perturbation'
        '3D_minimal:Minimal 3D case with spherical perturbation'
    )

    _arguments -C \
        '1: :->command' \
        '*:: :->args'

    case $state in
        command)
            _describe -t commands 'mfc command' commands
            ;;
        args)
            case $words[1] in
                build)
                    _arguments \
                        '-t[Targets to build]:target:->targets' \
                        '--targets[Targets to build]:target:->targets' \
                        '-j[Number of parallel jobs]:jobs:(1 2 4 8 16 32)' \
                        '--jobs[Number of parallel jobs]:jobs:(1 2 4 8 16 32)' \
                        '-v[Enable verbose output]' \
                        '--verbose[Enable verbose output]' \
                        '-d[Enable debug logging]' \
                        '--debug-log[Enable debug logging]' \
                        '--mpi[Enable MPI]' \
                        '--no-mpi[Disable MPI]' \
                        '--gpu[Enable GPU support]:mode:(acc mp)' \
                        '--no-gpu[Disable GPU support]' \
                        '--debug[Enable debug build]' \
                        '--no-debug[Disable debug build]' \
                        '-i[Input case for optimization]:file:_files -g "*.py"' \
                        '--input[Input case for optimization]:file:_files -g "*.py"' \
                        '--case-optimization[Enable case-specific optimization]'

                    case $state in
                        targets)
                            _describe -t targets 'build target' targets
                            ;;
                    esac
                    ;;
                run)
                    _arguments \
                        '1:case file:_files -g "*.py"' \
                        '-n[Number of nodes]:nodes:' \
                        '--nodes[Number of nodes]:nodes:' \
                        '-N[Tasks per node]:tasks:' \
                        '--tasks-per-node[Tasks per node]:tasks:' \
                        '-w[Wall time]:time:' \
                        '--walltime[Wall time]:time:' \
                        '-a[Account name]:account:' \
                        '--account[Account name]:account:' \
                        '-p[Partition name]:partition:' \
                        '--partition[Partition name]:partition:' \
                        '-e[Execution engine]:engine:(interactive batch)' \
                        '--engine[Execution engine]:engine:(interactive batch)' \
                        '-t[Targets to run]:target:->targets' \
                        '--targets[Targets to run]:target:->targets' \
                        '--mpi[Enable MPI]' \
                        '--no-mpi[Disable MPI]' \
                        '--gpu[Enable GPU]:mode:(acc mp)' \
                        '--no-gpu[Disable GPU]'

                    case $state in
                        targets)
                            _describe -t targets 'target' targets
                            ;;
                    esac
                    ;;
                test)
                    _arguments \
                        '-j[Number of parallel jobs]:jobs:(1 2 4 8 16 32)' \
                        '--jobs[Number of parallel jobs]:jobs:(1 2 4 8 16 32)' \
                        '--only[Run only specific tests]:uuid:' \
                        '--from[Start from test UUID]:uuid:' \
                        '--to[End at test UUID]:uuid:' \
                        '--generate[Generate golden files]' \
                        '--mpi[Enable MPI]' \
                        '--no-mpi[Disable MPI]' \
                        '--gpu[Enable GPU]:mode:(acc mp)' \
                        '--no-gpu[Disable GPU]'
                    ;;
                validate)
                    _arguments \
                        '1:case file:_files -g "*.py"' \
                        '-d[Enable debug logging]' \
                        '--debug-log[Enable debug logging]'
                    ;;
                init)
                    _arguments \
                        '1:case name:_files -/' \
                        '-t[Template to use]:template:->templates' \
                        '--template[Template to use]:template:->templates' \
                        '-l[List available templates]' \
                        '--list[List available templates]'

                    case $state in
                        templates)
                            _describe -t templates 'template' templates
                            ;;
                    esac
                    ;;
                packer)
                    local -a packer_cmds=(
                        'pack:Pack a case into a single file'
                        'compare:Compare two packed files'
                    )
                    _arguments \
                        '1: :->packer_cmd' \
                        '*:: :->packer_args'

                    case $state in
                        packer_cmd)
                            _describe -t packer_cmds 'packer command' packer_cmds
                            ;;
                        packer_args)
                            case $words[1] in
                                pack)
                                    _arguments '1:case file:_files -g "*.py"'
                                    ;;
                                compare)
                                    _arguments \
                                        '1:first pack file:_files -g "*.pack"' \
                                        '2:second pack file:_files -g "*.pack"'
                                    ;;
                            esac
                            ;;
                    esac
                    ;;
                load)
                    _arguments \
                        '-c[Cluster]:cluster:(p f s a)' \
                        '-m[Mode]:mode:(c g)'
                    ;;
                completion)
                    local -a completion_cmds=(
                        'install:Install shell completion'
                        'uninstall:Remove shell completion'
                        'status:Show completion status'
                    )
                    _arguments \
                        '1: :->completion_cmd' \
                        '*:: :->completion_args'

                    case $state in
                        completion_cmd)
                            _describe -t completion_cmds 'completion command' completion_cmds
                            ;;
                        completion_args)
                            case $words[1] in
                                install)
                                    _arguments '1:shell:(bash zsh)'
                                    ;;
                            esac
                            ;;
                    esac
                    ;;
                clean|count|interactive|lint|format|spelling)
                    # No additional arguments
                    ;;
            esac
            ;;
    esac
}

_mfc "$@"
